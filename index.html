<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verifina.pro - Scam Detector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: url('https://images.unsplash.com/photo-1521737604893-d14cc237f11d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80');
      background-size: cover;
      font-family: 'Georgia', serif;
    }
    .glass {
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(12px);
    }
    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #ffd700;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    .blurred {
      filter: blur(8px);
      user-select: none;
      pointer-events: none;
    }
    /* Default state for the freeResult div */
    .locked .locked-content {
      filter: blur(8px); /* Blur content when locked */
      user-select: none;
      pointer-events: none;
    }
    .locked .premium-overlay {
        display: block; /* Show overlay when locked */
    }
    .unlocked .locked-content {
      filter: none; /* No blur when unlocked */
      user-select: auto;
      pointer-events: auto;
    }
    .unlocked .premium-overlay {
      display: none; /* Hide overlay when unlocked */
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body class="text-white min-h-screen flex items-center justify-center p-4">
  <div class="glass p-8 rounded-xl shadow-2xl max-w-2xl w-full">
    <h1 class="text-4xl font-bold text-yellow-300 mb-4 text-center">üîç Verifina.pro</h1>
    <p class="text-lg mb-6 text-center">Check if any website is a scam</p>

    <form id="checkForm" class="mb-6">
      <input 
        type="text" 
        id="urlInput" 
        placeholder="example.com" 
        class="w-full p-3 rounded mb-4 bg-black bg-opacity-50 border border-yellow-400"
        required
      >
      <button 
        type="submit" 
        id="checkBtn" 
        class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 px-6 rounded-lg w-full flex items-center justify-center"
      >
        <span id="spinner" class="spinner hidden mr-2"></span>
        <span id="btnText">Check Website</span>
      </button>
    </form>

    <div id="resultContainer" class="hidden">
      <div id="freeResult" class="locked"> <h2 class="text-xl font-bold mb-2">Scam Analysis</h2>
        <div id="reportContent" class="locked-content bg-black bg-opacity-50 p-4 rounded-lg mb-4 whitespace-pre-line"></div>
        
        <div id="premiumOverlay" class="premium-overlay absolute inset-0 bg-black bg-opacity-80 p-6 rounded-lg text-center flex flex-col justify-center items-center">
          <h3 class="text-xl font-bold text-yellow-300 mb-2">üîí Premium Report</h3>
          <p class="mb-4">This report is locked. Unlock with a license key:</p>
          
          <div class="flex mb-4 w-full max-w-sm">
            <input 
              type="text" 
              id="licenseKey" 
              placeholder="VF-XXXXXXXX"  class="flex-1 p-2 rounded-l bg-gray-800 text-white"
            >
            <button 
              id="unlockBtn"
              class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-4 rounded-r"
            >
              Unlock
            </button>
          </div>
          <p id="licenseMessage" class="text-red-400 mb-2"></p>
          
          <button 
            id="getLicenseKeyBtn"
            class="block bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg mb-2 text-lg pulse w-full max-w-sm"
          >
            üö® GET LICENSE KEY ($2 PER CHECK) üö®
          </button>
          
          <p class="text-xs text-gray-400">Keys are delivered instantly via email</p>
        </div>
      </div>
    </div>
  <div class="mt-8 text-center text-sm text-gray-300 border-t border-gray-700 pt-4">
      <p class="mb-1">‚ö†Ô∏è Verifina can make mistakes. Always double-check manually.</p>
      <p>üì© Contact: <a href="mailto:Verifina.pro@gmail.com" class="text-yellow-300 underline">Verifina.pro@gmail.com</a></p>
    </div>
  </div>

  <script>
    // Function to update the UI based on remaining checks
    function updateReportUI(checksRemaining) {
      const freeResultDiv = document.getElementById('freeResult');
      if (checksRemaining > 0) {
        freeResultDiv.classList.remove('locked');
        freeResultDiv.classList.add('unlocked');
      } else {
        freeResultDiv.classList.add('locked');
        freeResultDiv.classList.remove('unlocked');
      }
    }

    document.getElementById('checkForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const url = document.getElementById('urlInput').value.trim();
      if (!url) return alert('Please enter a website URL');
      
      const btn = document.getElementById('checkBtn');
      btn.disabled = true;
      document.getElementById('spinner').classList.remove('hidden');
      document.getElementById('btnText').textContent = 'Analyzing...';
      document.getElementById('licenseMessage').textContent = ''; // Clear previous messages
      
      try {
        const response = await fetch('/api/check', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ domain: url })
        });
        
        const data = await response.json();
        document.getElementById('resultContainer').classList.remove('hidden');
        
        if (response.ok) { // Check if the response status is 2xx
            document.getElementById('reportContent').textContent = data.full_report;
            updateReportUI(data.checks_remaining);
        } else {
            document.getElementById('reportContent').textContent = data.error || 'Failed to get report.';
            updateReportUI(0); // Ensure it's locked if there's an error requiring a license
            if (data.message) {
                document.getElementById('licenseMessage').textContent = data.message;
            }
        }
        
      } catch (error) {
        alert('Error: ' + error.message);
        document.getElementById('reportContent').textContent = 'Error: Could not analyze the domain.';
        updateReportUI(0); // Lock on network/unhandled error
      } finally {
        btn.disabled = false;
        document.getElementById('spinner').classList.add('hidden');
        document.getElementById('btnText').textContent = 'Check Website';
      }
    });

    // --- START OF DEEPSEEK CHANGES ---
    document.getElementById('unlockBtn').addEventListener('click', async () => {
        const licenseKeyInput = document.getElementById('licenseKey');
        const licenseKey = licenseKeyInput.value.trim().toUpperCase();
        const licenseMessage = document.getElementById('licenseMessage');

        if (!licenseKey) {
            licenseMessage.textContent = 'Please enter your license key.';
            licenseMessage.style.color = 'red';
            return;
        }
        
        const btn = document.getElementById('unlockBtn');
        btn.disabled = true;
        btn.textContent = 'Verifying...';
        licenseMessage.textContent = ''; // Clear previous messages
        
        try {
            const response = await fetch('/api/verify-license', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ license_key: licenseKey })
            });
            
            const data = await response.json();
            if (response.ok && data.status === 'success') {
                licenseMessage.textContent = data.message;
                licenseMessage.style.color = 'lightgreen';
                // Immediately unlock the report because a check was added
                updateReportUI(1); // Set to 1 to indicate a check is now available
                licenseKeyInput.value = ''; // Clear the input field
            } else {
                licenseMessage.textContent = data.error || 'Invalid license key or unexpected error.';
                licenseMessage.style.color = 'red';
            }
        } catch (error) {
            licenseMessage.textContent = 'Verification failed. Please check your internet connection or try again.';
            licenseMessage.style.color = 'red';
        } finally {
            btn.disabled = false;
            btn.textContent = 'Unlock';
        }
    });

    // Add this new function for checkout
    async function initiateCheckout() {
        try {
            const response = await fetch('/api/generate-license', {
                method: 'POST',
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to generate license key.');
            }

            const { license_key, checkout_url } = await response.json();
            
            // Store the key locally (optional, but good for auto-fill)
            localStorage.setItem('pending_license', license_key);
            
            // Redirect to Gumroad
            window.open(checkout_url, '_blank');
            
            // Auto-fill the key when user returns (optional)
            // This event listener will only trigger if the page already exists and comes back into focus
            // Consider putting this listener outside a function if you want it to persist across navigation
            window.addEventListener('focus', () => {
                const storedKey = localStorage.getItem('pending_license');
                if (storedKey) {
                    document.getElementById('licenseKey').value = storedKey;
                    localStorage.removeItem('pending_license');
                }
            }, { once: true }); // Use { once: true } to ensure it only fires once after focus
        } catch (error) {
            document.getElementById('licenseMessage').textContent = `Error initiating checkout: ${error.message}`;
            document.getElementById('licenseMessage').style.color = 'red';
        }
    }

    document.getElementById('getLicenseKeyBtn').addEventListener('click', initiateCheckout);
    // --- END OF DEEPSEEK CHANGES ---

    // Initial check for a pending license key on page load (if user returns from Gumroad)
    window.addEventListener('load', () => {
        const storedKey = localStorage.getItem('pending_license');
        if (storedKey) {
            document.getElementById('licenseKey').value = storedKey;
            localStorage.removeItem('pending_license');
        }
    });

  </script>
</body>
</html>
